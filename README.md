# 쿠빵 (Coubbang) 프로젝트

🛍️ **쿠빵** - 상품을 검색/조회하고, 인기검색어를 조회하며, 쿠폰을 빠르고 정확하게 발급하는 서비스  
🔰 **상품 조회, 인기검색어 조회, 선착순 동시 쿠폰 발급 시스템**  

**프로젝트 기간**: 2025/01/31 ~ 2025/02/07


## ⭐️ **스파르타 내일배움캠프 플러스 프로젝트** : 8조 ⭐️
![쿠팡 쿠폰 메인 이미지](https://github.com/llRosell/Coupang/blob/dev/%E1%84%8F%E1%85%AE%E1%84%91%E1%85%A1%E1%86%BC%20%E1%84%8F%E1%85%AE%E1%84%91%E1%85%A9%E1%86%AB%20%E1%84%86%E1%85%A6%E1%84%8B%E1%85%B5%E1%86%AB.png?raw=true)


## 👤 팀원 소개

- **김리은**: Redis 분산락, 비관적 락, 낙관적 락을 이용한 동시성 제어, README 작성, 발표
- **최순우**: JWT와 Spring Security 인증/인가, Social Login, AWS 배포, 발표자료 준비
- **이경훈**: ElasticSearch를 이용한 인기 검색어 조회 기능
- **최대현**: 상품 목록 조회, Caching 성능 비교, 시연 영상 녹화


## 🚀 프로젝트 소개

### 🎯 프로젝트 목표

### 1. JWT 및 스프링 시큐리티 / OAuth 2.0 소셜 로그인
- JWT 및 Spring Security 설정을 통해 인증 및 인가 로직 구현
- OAuth 2.0을 사용하여 소셜 로그인 기능 구현

### 2. 데이터 처리 능력 강화
- **동시성 문제 해결**: 다수의 요청을 안정적으로 처리하기 위한 동시성 제어 방법 구현
  - 락을 설정하지 않으면 동시성 이슈가 발생하는지 검증하는 테스트 코드 작성
  - Redis Lock을 사용하여 동시성 이슈 제어
  - 동시성 이슈를 락을 통해 제어하는 테스트 코드 작성

### 3. Cache를 이용한 성능 개선
- 상품 목록 조회 API에 In-memory Cache 적용하여 성능 개선
- 적용 전, 적용 후 성능 테스트

### 4. ElasticSearch를 활용한 검색 서비스
- ElasticSearch를 이용한 인기 검색어 조회 및 상품 검색 기가 </summary>
 
## 🔑 **Social Login OAuth2.0 (Google)**
### 🔗 **Google OAuth 2.0을 활용한 로그인 기능 구현**
- Google OAuth 2.0을 활용하여 사용자가 쉽게 로그인할 수 있도록 지원
- 인증된 사용자 정보를 받아와 서버에서 관리

### 🔐 **JWT 기반 인증 및 인가 시스템 구축**
- OAuth2 Access Token 대신 서버에서 별도의 JWT를 발급하여 인증 및 인가 수행
- JWT를 활용하여 보안성을 높이고, 인증 요청 시 서버 부하 감소

### 📂 **MySQL(RDS) + Redis를 활용한 회원 관리 및 세션 유지**
- 회원 정보를 MySQL(RDS)에 저장하여 관리
- Refresh Token을 Redis에 저장하여 로그인 유지 및 재인증 처리 최적화
- Redis를 활용한 세션 캐싱으로 빠른 인증 처리 가능

### 📌 **아키텍처 개요**
![AWS Elastic Beanstalk 및 OAuth2 소셜 로그인 아키텍처](https://github.com/user-attachments/assets/af478284-df00-47be-8442-51e33d3c2b09)

위 사진 **AWS Elastic Beanstalk 기반의 배포 과정과 OAuth2 소셜 로그인 인증 흐름**을 나타냅니다.
1. 사용자가 Google OAuth2.0을 이용하여 로그인 요청
2. OAuth 인증 후, 서버에서 JWT를 발급하여 관리
3. 사용자 정보는 MySQL(RDS)에 저장, Refresh Token은 Redis를 활용하여 빠르게 처리
4. AWS Elastic Beanstalk을 이용한 서비스 배포 및 관리

이러한 구조를 통해 **보안성과 확장성을 갖춘 웹 서비스**를 운영할 수 있습니다. 🚀

 <summary>📊 [김리은] 1000개의 스레드, 선착순 100개의 쿠폰 발급 동시성 제어 </summary>

▶️ **테스트에 걸린 시간**:
- **분산 락**: 2초 722ms
- **낙관적 락**: 3초 488ms
- **비관적 락**: 3초 802ms

**분산 락 적용**
![image](https://github.com/llRosell/Coupang/blob/dev/%E1%84%87%E1%85%AE%E1%86%AB%E1%84%89%E1%85%A1%E1%86%AB%E1%84%85%E1%85%A1%E1%86%A8%201000%E1%84%80%E1%85%A2%202%E1%84%8E%E1%85%A9%20722ms.png?raw=true)
▶️  분산 락 2초722ms


**비관적 락 적용**
![image](https://github.com/llRosell/Coupang/blob/dev/%E1%84%87%E1%85%B5%E1%84%80%E1%85%AA%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%A8%E1%84%85%E1%85%A1%E1%86%A8%201000%E1%84%80%E1%85%A2%203%E1%84%8E%E1%85%A9%20802ms.png?raw=true)
▶️  비관적 락 3초802ms


분산 락이 가장 빠르며, 비관적 락은 상대적으로 느리다는 결과가 나왔습니다. 
동시성 제어를 테스트하기 위해 1000개의 스레드가 동시에 100개의 쿠폰을 발급받는 상황을 시뮬레이션하였고, 그 결과:
- **분산 락**이 가장 빠르게 동작했으며, **비관적 락**은 가장 느렸습니다.

### 선착순 쿠폰 발급 서비스

▶️ **데이터 정합성**:
- **분산 락 = 비관적 락 > 낙관적 락**
- 분산 락과 비관적 락은 항상 일관되게 100개의 쿠폰을 발급받음.
- 낙관적 락은 100개 이상의 쿠폰을 발급받는 테스트에서 실패하는 경우가 더 많음.

낙관적 락은 충돌이 자주 발생하는 환경에서는 적합하지 않다는 결론을 얻었습니다.

비관적 락은 많은 스레드가 동시에 몰릴 경우 DB 부하가 높아질 수 있습니다.

### 테스트 결과 분석

선착순 쿠폰 100개를 발급받는 서비스와 같이 짧은 시간에 충돌이 많이 발생하는 경우, **Redis 분산 락**을 사용하는 것이 가장 적합하다는 판단을 내렸습니다. 

#### 주요 결과:
- **분산 락**과 **비관적 락**은 항상 일관되게 100개의 쿠폰을 발급하며, 데이터 정합성을 보장합니다.
- **낙관적 락**은 락을 명확하게 설정하지 않고 버전 관리 방식(버전 어노테이션)을 사용하기 때문에, 동시 스레드 환경에서는 쿠폰 발급 수가 100개를 넘는 상황이 발생할 수 있습니다. 이로 인해 테스트에 실패하는 경우가 많았습니다.

#### 결론:
- **낙관적 락**은 충돌 발생이 잦은 환경에서는 적합하지 않으므로 사용을 피해야 합니다.
- **Redis 분산 락**은 충돌이 많이 발생하는 환경에서 데이터 정합성을 보장하고, 응답 시간이 빠르므로 **선택하는 것이 가장 효율적**입니다.
  

---
## 🔒 **트러블슈팅**

### 1. **SQL 최적화**: 검색 시 사용자가 선택한 조건의 조합에 따른 쿼리 적용 방법 고민
### 2. **동시성 제어**: 선착순 쿠폰 발급에 대한 데이터 정확성 확보
### 3. **AWS 배포 서버 중단 문제**: AWS EC2 인스턴스 중단 대응
### 4. **[이경훈] 엘라스틱 서치의 사용 이유**
   - Mysql로 기존의 30만 이상의 데이터에서 특정 단어가 포함된 데이터를 조회시 속도가 조금 느리다는 판단을 함(4.932초)
![image](https://github.com/user-attachments/assets/3b93d3f6-675f-492a-ba3c-88381c7cbb84)
   -  속도의 개선을 위해서 캐시를 적용하거나 페이징을 통해 카테고리화를 수행하여 속도를 올려봄
   -  **속도를 개선하다보니 많은 현업의 몇 천만 데이터를 관리하기 위해서는 새로운 해답이 필요하다 생각하게 됨**
   -  레디스를 찾다가 엘라스틱 서치라는 것을 알게되어 적용 시작
   -  **Mysql과 다른 역인덱스 구조가 검색의 속도를 비약적으로 빠르게 해준다는 것을 학습**, 적용함
   -  Mysql에서 일부를 처시할 경우 5초가 걸렸지만 엘라스틱 서치의 힌트와 캐시를 적용한 후엔 0.2초가 걸리게 바뀜
   -  최종적으로 엘라스틱 서치를 적용하여 검색 속도를 향상
   -  (다만, mysql도 인덱싱을 잘한 상태라면 적은 데이터 셋에서는 엘라스틱 서치보다 빠를 수 있어, 적재적소에 사용해야한다는 것을 유념)
     ![image](https://github.com/user-attachments/assets/9ec327a9-e366-4f5d-8c62-cd49329768b9)


---

## 📈 **추가 개선 가능 점**

- **대기열 시스템**: 대량의 트래픽이 몰리는 것을 방지하는 대기열 시스템 추가 예정
- **트래픽 이벤트 처리**: 트래픽이 몰릴 이벤트 상품 데이터를 미리 캐싱하여 빠른 처리 지원

### **[이경훈] 엘라스틱 서치 개발의 개선**
- 샤드 수가 너무 많으면 오버헤드가 증가하고, 너무 적으면 데이터 검색 속도가 저하된다. 이를 유념하여 조정이 필요하다.
- 데이터의 사용 빈도에 따라 핫(Hot), 웜(Warm), 콜드(Cold) 노드를 구성하여 리소스를 효율적으로 사용해야한다.
- 여러 클러스터로 나누어 데이터를 검색하거나 복자하여 대규모 환경에서도 안정적인 성능을 유지할 수 있도록 개발해야한다.
- 백업을 위한 스냅샷을 정기적으로 생성하도록 설정해야한다.
---

## 🤝 **팀원**

| 이름   | 깃허브                                                   |
|--------|---------------------------------------------------------|
| 최대현 | [https://github.com/DeaHyun0911](https://github.com/DeaHyun0911) |
| 김리은 | [https://github.com/llRosell](https://github.com/llRosell) |
| 최순우 | [https://github.com/asdd2557](https://github.com/asdd2557) |
| 이경훈 | [https://github.com/kyung412820](https://github.com/kyung412820) |

---

